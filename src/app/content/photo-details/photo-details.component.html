<div class="photo-details-container">
  <!-- Header Section -->
  <div class="details-header">
    <div class="header-content">
      <button class="back-btn" (click)="goBack()">
        <i class="fas fa-arrow-left"></i>
        Back to Properties
      </button>
      <div class="property-title">
        <h1>{{propertyData?.property_title}}</h1>
        <span class="listing-id">{{propertyData?.listing_id}}</span>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline-primary" (click)="exportPropertyData()">
          <i class="fas fa-download"></i>
          Export Data
        </button>
      </div>
    </div>
  </div>

  <!-- Top Navigation Cards -->
  <div class="top-navigation" *ngIf="propertyData?.competitor && propertyData.competitor.length > 0">
    <button class="nav-arrow prev" (click)="previousCompetitor()" [disabled]="selectedCompetitorIndex <= 0">
      <i class="fas fa-chevron-left"></i>
    </button>
    <div class="nav-cards" 
         (touchstart)="onTouchStart($event, 'competitor')"
         (touchmove)="onTouchMove($event)"
         (touchend)="onTouchEnd($event, 'competitor')"
         (mousedown)="onMouseDown($event, 'competitor')"
         (mousemove)="onMouseMove($event)"
         (mouseup)="onMouseUp($event, 'competitor')"
         (mouseleave)="onMouseUp($event, 'competitor')">
      <div class="nav-card" [class.active]="selectedCompetitorIndex === -1" (click)="selectCompetitor(-1)">
        <div class="nav-card-image">
          <img [src]="getMainImage()" [alt]="propertyData.property_title" (error)="onImageError($event)">
        </div>
        <div class="nav-card-content">
          <h4>Your Photos</h4>
          <span class="photo-count">{{propertyData.num_photos}} photos</span>
          <span class="gap-indicator">Your property</span>
        </div>
        <div class="nav-card-links">
          <i class="fas fa-link"></i>
        </div>
      </div>
      <!-- Selected Competitor Card (Always Second) -->
      <div class="nav-card" 
           [class.active]="selectedCompetitorIndex >= 0" 
           (click)="selectCompetitor(selectedCompetitorIndex >= 0 ? selectedCompetitorIndex : 0)">
        <div class="nav-card-image">
          <img [src]="getCurrentCompetitor()?.photos && getCurrentCompetitor()?.photos.length > 0 ? getCurrentCompetitor().photos[0].url : 'assets/images/placeholder.jpg'" 
               [alt]="getCurrentCompetitor()?.name || 'Competitor'" 
               (error)="onImageError($event)">
        </div>
        <div class="nav-card-content">
          <h4>{{getCurrentCompetitor()?.name || 'Select Competitor'}}</h4>
          <span class="photo-count">{{getCurrentCompetitor()?.num_photos || 0}} photos</span>
          <span class="gap-indicator" 
                [ngClass]="getGapClass((getCurrentCompetitor()?.num_photos || 0) - propertyData.num_photos)"
                *ngIf="getCurrentCompetitor()">
            {{(getCurrentCompetitor()?.num_photos || 0) - propertyData.num_photos > 0 ? '+' : ''}}{{(getCurrentCompetitor()?.num_photos || 0) - propertyData.num_photos}} {{(getCurrentCompetitor()?.num_photos || 0) - propertyData.num_photos > 0 ? 'more than you' : 'less than you'}}
          </span>
        </div>
        <div class="nav-card-links">
          <i class="fas fa-link"></i>
        </div>
      </div>
    </div>
    <button class="nav-arrow next" (click)="nextCompetitor()" [disabled]="selectedCompetitorIndex >= propertyData.competitor.length - 1">
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>

  <!-- Main Comparison Layout -->
  <div class="comparison-layout" *ngIf="propertyData">
    <!-- Your Photos Section -->
    <div class="comparison-section your-photos">
      <div class="section-header">
        <h2>Your photos</h2>
        <div class="review-summary">
          <span class="review-count">{{getReviewCount()}} reviews:</span>
          <div class="review-scores">
            <span class="score-item">
              <i class="fas fa-shower"></i>
              {{getReviewScore('cleanliness')}} cleanliness
            </span>
            <span class="score-item">
              <i class="fas fa-check"></i>
              {{getReviewScore('accuracy')}} accuracy
            </span>
            <span class="score-item">
              <i class="fas fa-user-check"></i>
              {{getReviewScore('checkin')}} check-in
            </span>
            <span class="score-item">
              <i class="fas fa-comments"></i>
              {{getReviewScore('communication')}} communication
            </span>
            <span class="score-item">
              <i class="fas fa-map-marker-alt"></i>
              {{getReviewScore('location')}} location
            </span>
            <span class="score-item">
              {{getReviewScore('value')}} value
            </span>
          </div>
        </div>
        <div class="photo-count">{{propertyData.num_photos}} photos</div>
      </div>
     
      <div class="main-image-container" 
           (touchstart)="onTouchStart($event, 'main')"
           (touchmove)="onTouchMove($event)"
           (touchend)="onTouchEnd($event, 'main')"
           (mousedown)="onMouseDown($event, 'main')"
           (mousemove)="onMouseMove($event)"
           (mouseup)="onMouseUp($event, 'main')"
           (mouseleave)="onMouseUp($event, 'main')">
        <img [src]="getCurrentImage()" [alt]="propertyData.property_title" class="main-image" (error)="onImageError($event)">
        <div class="image-badges">
          <div class="best-photo-badge" *ngIf="isBestPhoto()">
            <i class="fas fa-star"></i>
            BEST PHOTO
          </div>
        </div>
        <div class="image-navigation">
          <button class="nav-btn prev" (click)="previousImage()" *ngIf="currentImageIndex > 0">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="nav-btn next" (click)="nextImage()" *ngIf="currentImageIndex < getTotalImages() - 1">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div class="image-caption-error" *ngIf="!hasCurrentImageCaption()">
          <i class="fas fa-exclamation-triangle"></i>
          No caption set for this photo
        </div>
        
      </div>
    
      
     
      
      <!-- Thumbnail Gallery -->
      <div class="thumbnail-gallery" 
           (touchstart)="onThumbnailTouchStart($event, 'main')"
           (touchmove)="onThumbnailTouchMove($event)"
           (touchend)="onThumbnailTouchEnd($event, 'main')"
           (mousedown)="onThumbnailMouseDown($event, 'main')"
           (mousemove)="onThumbnailMouseMove($event)"
           (mouseup)="onThumbnailMouseUp($event, 'main')"
           (mouseleave)="onThumbnailMouseUp($event, 'main')">
        
        <!-- Thumbnail Navigation Arrows -->
        <div class="thumbnail-navigation">
          <button class="thumbnail-nav-btn prev" 
                  (click)="previousImage()" 
                  *ngIf="currentImageIndex > 0"
                  title="Previous photo">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="thumbnail-nav-btn next" 
                  (click)="nextImage()" 
                  *ngIf="currentImageIndex < getTotalImages() - 1"
                  title="Next photo">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <div class="thumbnail-item" 
             *ngFor="let photo of getVisibleThumbnails('main'); let i = index"
             [class.active]="getThumbnailIndex('main', i) === currentImageIndex"
             [class.disabled]="photo === null"
             (click)="photo && setCurrentImage(getThumbnailIndex('main', i))">
          <img *ngIf="photo" [src]="photo.url" [alt]="photo.caption || 'Property photo'" (error)="onImageError($event)">
          <div *ngIf="photo" class="thumbnail-number">{{getThumbnailIndex('main', i) + 1}}</div>
        </div>
      </div>
    </div>

    <!-- Competitor Photos Section -->
    <div class="comparison-section competitor-photos" *ngIf="getCurrentCompetitor()">
      <div class="section-header">
        <h2>{{getCurrentCompetitor().name}}</h2>
        <div class="review-summary">
          <span class="review-count">{{getCurrentCompetitor().reviews_count}} reviews:</span>
          <div class="review-scores">
            <span class="score-item">
              <i class="fas fa-shower"></i>
              {{getCurrentCompetitor().reviews_score}} cleanliness
            </span>
            <span class="score-item">
              <i class="fas fa-check"></i>
              {{getCurrentCompetitor().reviews_score}} accuracy
            </span>
            <span class="score-item">
              <i class="fas fa-user-check"></i>
              {{getCurrentCompetitor().reviews_score}} check-in
            </span>
            <span class="score-item">
              <i class="fas fa-comments"></i>
              {{getCurrentCompetitor().reviews_score}} communication
            </span>
            <span class="score-item">
              <i class="fas fa-map-marker-alt"></i>
              {{getCurrentCompetitor().reviews_score}} location
            </span>
            <span class="score-item">
              {{getCurrentCompetitor().reviews_score}} value
            </span>
          </div>
        </div>
        <div class="photo-count">{{getCurrentCompetitor().num_photos}} photos</div>
      </div>
      
      <div class="main-image-container" 
           (touchstart)="onTouchStart($event, 'competitor')"
           (touchmove)="onTouchMove($event)"
           (touchend)="onTouchEnd($event, 'competitor')"
           (mousedown)="onMouseDown($event, 'competitor')"
           (mousemove)="onMouseMove($event)"
           (mouseup)="onMouseUp($event, 'competitor')"
           (mouseleave)="onMouseUp($event, 'competitor')">
        <img [src]="getCurrentCompetitorImage()" [alt]="getCurrentCompetitor().name" class="main-image" (error)="onImageError($event)">
        <div class="image-navigation">
          <button class="nav-btn prev" (click)="previousCompetitorImage()" *ngIf="currentCompetitorImageIndex > 0">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="nav-btn next" (click)="nextCompetitorImage()" *ngIf="currentCompetitorImageIndex < getCurrentCompetitor().photos.length - 1">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
         <div class="image-caption-error" *ngIf="!hasCurrentCompetitorImageCaption()">
        <i class="fas fa-exclamation-triangle"></i>
        No caption set for this photo
      </div>
      </div>
      
     
      
      <!-- Competitor Thumbnail Gallery -->
      <div class="thumbnail-gallery" 
           (touchstart)="onThumbnailTouchStart($event, 'competitor')"
           (touchmove)="onThumbnailTouchMove($event)"
           (touchend)="onThumbnailTouchEnd($event, 'competitor')"
           (mousedown)="onThumbnailMouseDown($event, 'competitor')"
           (mousemove)="onThumbnailMouseMove($event)"
           (mouseup)="onThumbnailMouseUp($event, 'competitor')"
           (mouseleave)="onThumbnailMouseUp($event, 'competitor')">
        
        <!-- Competitor Thumbnail Navigation Arrows -->
        <div class="thumbnail-navigation">
          <button class="thumbnail-nav-btn prev" 
                  (click)="previousCompetitorImage()" 
                  *ngIf="currentCompetitorImageIndex > 0"
                  title="Previous competitor photo">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="thumbnail-nav-btn next" 
                  (click)="nextCompetitorImage()" 
                  *ngIf="currentCompetitorImageIndex < getCurrentCompetitor().photos.length - 1"
                  title="Next competitor photo">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <div class="thumbnail-item" 
             *ngFor="let photo of getVisibleThumbnails('competitor'); let i = index"
             [class.active]="getThumbnailIndex('competitor', i) === currentCompetitorImageIndex"
             [class.disabled]="photo === null"
             (click)="photo && setCurrentCompetitorImage(getThumbnailIndex('competitor', i))">
          <img *ngIf="photo" [src]="photo.url" [alt]="photo.caption || 'Competitor photo'" (error)="onImageError($event)">
          <div *ngIf="photo" class="thumbnail-number">{{getThumbnailIndex('competitor', i) + 1}}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Competitor Comparison -->
  <div class="competitor-section" *ngIf="propertyData?.competitor && propertyData.competitor.length > 0">
    <h2>Competitor Comparison</h2>
    <div class="competitor-grid">
      <div class="competitor-card" *ngFor="let comp of propertyData.competitor">
        <div class="competitor-header">
          <h3>{{comp.name}}</h3>
          <div class="competitor-rating">
            <i class="fas fa-star"></i>
            <span>{{comp.reviews_score}}</span>
            <span class="reviews-count">({{comp.reviews_count}} reviews)</span>
          </div>
        </div>
        <div class="competitor-stats">
          <div class="stat-row">
            <span class="label">Photos:</span>
            <span class="value">{{comp.num_photos}}</span>
          </div>
          <div class="stat-row">
            <span class="label">Photo Gap:</span>
            <span class="value" [ngClass]="getGapClass(comp.num_photos - propertyData.num_photos)">
              {{comp.num_photos - propertyData.num_photos > 0 ? '+' : ''}}{{comp.num_photos - propertyData.num_photos}}
            </span>
          </div>
          <div class="stat-row">
            <span class="label">Location Score:</span>
            <span class="value">{{comp.location_score}}</span>
          </div>
        </div>
        <div class="competitor-links">
          <a [href]="comp.airbnb_link" target="_blank" class="platform-link airbnb">
            <i class="fab fa-airbnb"></i>
          </a>
          <a [href]="comp.booking_link" target="_blank" class="platform-link booking">
            <i class="fas fa-bed"></i>
          </a>
          <a [href]="comp.vrbo_link" target="_blank" class="platform-link vrbo">
            <i class="fas fa-home"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Additional Photo Suggestions -->
  <div class="photo-suggestions-section" *ngIf="getPhotoSuggestions().length > 0">
    <div class="suggestions-header">
      <h2>Additional photo suggestions</h2>
      <button class="refresh-btn" (click)="refreshSuggestions()" title="Refresh suggestions">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
    <div class="suggestions-list">
      <div class="suggestion-item" *ngFor="let suggestion of getPhotoSuggestions()">
        <div class="suggestion-status">
          <i class="fas" [ngClass]="suggestion.available ? 'fa-check' : 'fa-times'" 
             [class.status-available]="suggestion.available" 
             [class.status-unavailable]="!suggestion.available"></i>
        </div>
        <div class="suggestion-content">
          <div class="suggestion-main">
            <span class="suggestion-title">{{suggestion.title}}</span>
            <div class="suggestion-meta" *ngIf="suggestion.impact && suggestion.effort">
              <span class="impact-badge" [ngClass]="'impact-' + suggestion.impact">{{suggestion.impact}} impact</span>
              <span class="effort-badge" [ngClass]="'effort-' + suggestion.effort">{{suggestion.effort}} effort</span>
            </div>
          </div>
          <div class="info-icon-container">
            <i class="fas fa-info-circle info-icon" 
               (click)="showSuggestionInfo(suggestion)"></i>
            <div class="tooltip">{{suggestion.description}}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  

  <!-- Photo Gallery -->
  <!-- <div class="photo-gallery" *ngIf="propertyData?.property_photos">
    <h2>Photo Gallery</h2>
    <div class="gallery-grid">
      <div class="photo-item" *ngFor="let photo of propertyData.property_photos; let i = index" (click)="openPhotoModal(i)">
        <img [src]="photo.url" [alt]="photo.caption || 'Property photo'" (error)="onImageError($event)">
        <div class="photo-overlay">
          <div class="photo-info">
            <span class="photo-type">{{photo.type}}</span>
            <span class="photo-caption" *ngIf="photo.caption">{{photo.caption}}</span>
            <span class="no-caption" *ngIf="!photo.caption">
              <i class="fas fa-exclamation-triangle"></i>
              No Caption
            </span>
          </div>
        </div>
      </div>
    </div>
  </div> -->

  <!-- Missing Captions Section -->
  <div class="missing-captions-section" *ngIf="propertyData?.missing_captions > 0">
    <h2>Missing Captions</h2>
    <div class="missing-list">
      <div class="missing-item" *ngFor="let photoId of getMissingCaptionPhotos()">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Photo {{photoId}} needs a caption</span>
        <button class="btn btn-sm btn-primary">Add Caption</button>
      </div>
    </div>
  </div>
</div>

<!-- Photo Modal -->
<div class="photo-modal" *ngIf="selectedPhotoIndex !== null" (click)="closePhotoModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closePhotoModal()">
      <i class="fas fa-times"></i>
    </button>
    <div class="modal-image">
      <img [src]="getSelectedPhoto()?.url" [alt]="getSelectedPhoto()?.caption" (error)="onImageError($event)">
    </div>
    <div class="modal-info">
      <h3>{{getSelectedPhoto()?.type}}</h3>
      <p *ngIf="getSelectedPhoto()?.caption">{{getSelectedPhoto()?.caption}}</p>
      <p *ngIf="!getSelectedPhoto()?.caption" class="no-caption">
        <i class="fas fa-exclamation-triangle"></i>
        This photo needs a caption
      </p>
    </div>
    <div class="modal-navigation">
      <button class="nav-btn prev" (click)="previousPhoto()" *ngIf="selectedPhotoIndex > 0">
        <i class="fas fa-chevron-left"></i>
      </button>
      <button class="nav-btn next" (click)="nextPhoto()" *ngIf="selectedPhotoIndex < propertyData.property_photos.length - 1">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>
</div>