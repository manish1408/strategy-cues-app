<div class="revenue-dashboard">


  <div class="deployment-cues-container">
    <div class="row">
      <div class="col-4">
        <button class="btn btn-primary btn-lg float-end" style="margin-top: 30%;">
          <i class="fas fa-chevron-left"></i>
        </button>
      </div>
      <div class="col-4">
        <div class="cue-card">
          <div class="cue-card-header">
            <div class="cue-card-title">
              <h6>Deployment Cues 1 </h6>
              <span class="badge bg-secondary">Critical</span>
            </div>
            <div class="cue-card-actions">
              <button class="btn btn-sm btn-outline-primary me-1" (click)="openCueFormModal('deployment1')"
                title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" (click)="deleteCue('deployment1')" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="cue-card-body">
            <div class="cue-conditions">
              <div class="condition-row">
                <strong>Days left:</strong> 45-28
              </div>
              <div class="condition-row">
                <strong>Base occupancy:</strong> 20%
              </div>
            </div>
            <div class="pickup-case">
              <div class="row">
                <div class="col-8">
                  <strong>Pickup Case 1:</strong> 0
                  <div class="action-badge">Reduce the month by 15%</div>
                </div>
                <div class="col-4">
                  <button class="btn btn-sm btn-primary float-end" title="Add Note">Add</button>
                </div>
              </div>
            </div>
           
            <div class="pickup-case">
              <div class="row">
                <div class="col-8">
                  <strong>Pickup Case 1:</strong> 0
                  <div class="action-badge">Reduce the month by 15%</div>
                </div>
                <div class="col-4">
                  <button class="btn btn-sm btn-primary float-end" title="Add Note">Add</button>
                </div>
              </div>
            </div>
            <div class="pickup-case">
              <div class="row">
                <div class="col-8">
                  <strong>Pickup Case 1:</strong> 0
                  <div class="action-badge">Reduce the month by 15%</div>
                </div>
                <div class="col-4">
                  <button class="btn btn-sm btn-primary float-end" title="Add Note">Add</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-4">
        <button class="btn btn-primary btn-lg" style="margin-top: 30%;">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>



    <div *ngIf="loading" class="text-center py-3">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">Loading ...</span>
      </div>
    </div>
    <div class="table-container mt-4">
      <div *ngIf="!loading && getFilteredPropertyData() && getFilteredPropertyData().length > 0">
        <table>
          <thead>
            <tr>
              <th>Listing Name</th>
              <th>Deployment Cue</th>
              <th>Pick Up Case</th>
              <th>Assigned To</th>
              <th>Status</th>
              <th>Notes</th>
              <th>Occupancy This Month</th>
              <th>Occupancy Next Month</th>
              <th>Average Daily Rate</th>
              <th>Revenue Per Available Room</th>
              <th>Market Penetration Index</th>
              <th>STLY <br />Var Occ</th>
              <th>STLY Var <br /> RevPAR</th>
              <th>Min Rate <br /> Threshold</th>
              <th>Pick up Occ</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let property of getFilteredPropertyData()">
              <td class="property-cell">
                <div class="property-info">
                  <div class="property-details">
                    <h4 [title]="property.Listing_Name" [attr.aria-label]="property.Listing_Name">{{
                      property.Listing_Name
                      }}</h4>

                  </div>
                </div>
              </td>
              <td class="deployment-cues-cell">
                <!-- Hardcoded Demo Cues -->
                <div class="cues-container">
                  <div class="cue-item">
                    <div class="cue-name">Deployment Cue 1</div>
                  </div>
                </div>
              </td>
              <td class="pickup-case-cell">
                <div class="pickup-case-container">
                  <div class="pickup-case-item">
                    <div class="pickup-case-name">Pick Up Case 2</div>
                  </div>
                </div>
              </td>
              <td class="assigned-to-cell">
                <select class="form-select form-select-sm">
                  <option value="">Select Assignee</option>
                  <option value="ishan">Ishan</option>
                  <option value="manish">Manish</option>
                </select>
              </td>
              <td class="status-cell">
                <select class="form-select form-select-sm status-dropdown">
                  <option value="">Select Status</option>
                  <option value="pending">Pending</option>
                  <option value="working">Working</option>
                  <option value="done">Done</option>
                </select>
              </td>
              <td class="notes-cell">
                <div class="notes-container">
                  <button class="btn btn-sm btn-outline-secondary" (click)="openNotesModal(property._id)">
                    <i class="fas fa-sticky-note me-1"></i>
                    <span class="notes-count">3 Notes</span>
                  </button>
                </div>
              </td>
              <td>
                <span class="badge badge-light-gray me-1">
                  {{ safeParseNumber(property.Occupancy.TM) || 0 }} %
                </span>
              </td>
              <td>
                <span class="badge badge-light-gray me-1">
                  {{ safeParseNumber(property.Occupancy.NM) || 0 }} %
                </span>
              </td>
              <td>
                <div class="dual-value-cell">
                  <div class="value-pair" *ngIf="property.ADR">
                    <span class="badge badge-light-gray me-1">This Month: {{ property.ADR.TM || 'N/A'
                      }}</span>
                    <span class="badge badge-light-gray">Next Month: {{ property.ADR.NM || 'N/A'
                      }}</span>
                  </div>
                  <div class="value-pair" *ngIf="!property.ADR">
                    <span class="text-muted">N/A</span>
                  </div>
                </div>
              </td>
              <td>
                <div class="dual-value-cell">
                  <div class="value-pair" *ngIf="property.RevPAR">
                    <span class="badge badge-light-gray me-1">This Month: {{ property.RevPAR.TM || 'N/A'
                      }}</span>
                    <span class="badge badge-light-gray">Next Month: {{ property.RevPAR.NM || 'N/A'
                      }}</span>
                  </div>
                  <div class="value-pair" *ngIf="!property.RevPAR">
                    <span class="text-muted">N/A</span>
                  </div>
                </div>
              </td>
              <td>
                <div class="dual-value-cell">
                  <div class="value-pair" *ngIf="property.MPI">
                    <span class="badge badge-light-gray me-1">This Month: {{ safeParseNumber(property.MPI.TM) }}%</span>
                    <span class="badge badge-light-gray me-1">Next Month: {{ safeParseNumber(property.MPI.NM) }}%</span>
                    <span class="badge badge-light-gray me-1">LYTM: {{ safeParseNumber(property.MPI.LYTM) }}%</span>
                  </div>
                  <div class="value-pair" *ngIf="!property.MPI">
                    <span class="text-muted">N/A</span>
                  </div>
                </div>
              </td>
              <td>
                <div class="stly-var-single-cell">
                  <span class="badge" [ngClass]="getPerformanceClass(property.STLY_Var.Occ)">
                    {{ property.STLY_Var.Occ }}
                  </span>
                </div>
              </td>
              <td>
                <div class="stly-var-single-cell">
                  <span class="badge" [ngClass]="getPerformanceClass(property.STLY_Var.RevPAR)">
                    {{ property.STLY_Var.RevPAR }}
                  </span>
                </div>
              </td>
              <td>
                <div class="min-rate-threshold-cell">
                  <span class="threshold-value">{{ property.Min_Rate_Threshold || 'N/A' }}</span>
                </div>
              </td>
              <td>
                <div class="pickup-occ-cell">
                  <div class="pickup-item"
                    *ngIf="property.Pick_Up_Occ && property.Pick_Up_Occ['7_Days'] !== null && property.Pick_Up_Occ['7_Days'] !== undefined">
                    <span class="pickup-label">7D:</span>
                    <span class="pickup-value">{{ property.Pick_Up_Occ['7_Days'] }}</span>
                  </div>
                  <div class="pickup-item"
                    *ngIf="!property.Pick_Up_Occ || property.Pick_Up_Occ['7_Days'] === null || property.Pick_Up_Occ['7_Days'] === undefined">
                    <span class="pickup-label">7D:</span>
                    <span class="pickup-value na-value">N/A</span>
                  </div>
                  <div class="pickup-item"
                    *ngIf="property.Pick_Up_Occ && property.Pick_Up_Occ['14_Days'] !== null && property.Pick_Up_Occ['14_Days'] !== undefined">
                    <span class="pickup-label">14D:</span>
                    <span class="pickup-value">{{ property.Pick_Up_Occ['14_Days'] }}</span>
                  </div>
                  <div class="pickup-item"
                    *ngIf="!property.Pick_Up_Occ || property.Pick_Up_Occ['14_Days'] === null || property.Pick_Up_Occ['14_Days'] === undefined">
                    <span class="pickup-label">14D:</span>
                    <span class="pickup-value na-value">N/A</span>
                  </div>
                  <div class="pickup-item"
                    *ngIf="property.Pick_Up_Occ && property.Pick_Up_Occ['30_Days'] !== null && property.Pick_Up_Occ['30_Days'] !== undefined">
                    <span class="pickup-label">30D:</span>
                    <span class="pickup-value">{{ property.Pick_Up_Occ['30_Days'] }}</span>
                  </div>
                  <div class="pickup-item"
                    *ngIf="!property.Pick_Up_Occ || property.Pick_Up_Occ['30_Days'] === null || property.Pick_Up_Occ['30_Days'] === undefined">
                    <span class="pickup-label">30D:</span>
                    <span class="pickup-value na-value">N/A</span>
                  </div>
                </div>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary btn-sm" (click)="viewDetails(property._id)">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Deployment Cue Form Modal -->
  <div class="modal fade" id="cueFormModal" tabindex="-1" aria-labelledby="cueFormModalLabel" aria-hidden="true"
    [class.show]="showCueFormModal" [style.display]="showCueFormModal ? 'block' : 'none'">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cueFormModalLabel">
            <i class="fas fa-edit me-2"></i>{{ editingCueId ? 'Edit' : 'Create' }} Deployment Cue
          </h5>
          <button type="button" class="btn-close" (click)="closeCueFormModal()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form #cueForm="ngForm">
            <div class="mb-3">
              <label for="cueName" class="form-label">Cue Name *</label>
              <input type="text" class="form-control" id="cueName" [(ngModel)]="cueFormData.name" name="cueName"
                required placeholder="Enter cue name">
            </div>

            <div class="mb-3">
              <label for="cueProperties" class="form-label">Properties *</label>
              <ngx-select-dropdown [config]="propertyDropdownConfig" [options]="propertyOptions"
                [(ngModel)]="cueFormData.properties" name="cueProperties" [multiple]="true"
                (change)="onPropertySelectionChange()">
              </ngx-select-dropdown>
              <small class="text-muted">Search and select multiple properties</small>
            </div>

            <div class="mb-3">
              <label for="cueDescription" class="form-label">Description *</label>
              <textarea class="form-control" id="cueDescription" [(ngModel)]="cueFormData.description"
                name="cueDescription" rows="3" required placeholder="Enter cue description"></textarea>
            </div>

            <div class="mb-3">
              <label for="cueActions" class="form-label">Actions (comma separated) *</label>
              <input type="text" class="form-control" id="cueActions" [(ngModel)]="cueFormData.actions"
                name="cueActions" required placeholder="e.g., Adjust Pricing, Promote Listing">
              <small class="text-muted">Enter actions separated by commas</small>
            </div>

            <div class="mb-3">
              <label for="cueStatus" class="form-label">Status *</label>
              <select class="form-select" id="cueStatus" [(ngModel)]="cueFormData.status" name="cueStatus" required>
                <option value="">Select Status</option>
                <option value="Active">Active</option>
                <option value="Pending">Pending</option>
                <option value="Urgent">Urgent</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeCueFormModal()">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="saveCue()" [disabled]="!cueForm.form.valid">
            <i class="fas fa-save me-2"></i>{{ editingCueId ? 'Update' : 'Create' }} Cue
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Backdrop for Cue Form -->
  <div class="modal-backdrop fade" [class.show]="showCueFormModal" *ngIf="showCueFormModal"
    (click)="closeCueFormModal()"></div>

  <!-- Notes Modal -->
  <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true"
    [class.show]="showNotesModal" [style.display]="showNotesModal ? 'block' : 'none'">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="notesModalLabel">
            <i class="fas fa-sticky-note me-2"></i>Notes
          </h5>
          <button type="button" class="btn-close" (click)="closeNotesModal()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Add New Note Section -->
          <div class="add-note-section">
            <h6 class="mb-3">Add New Note</h6>
            <form #noteForm="ngForm">
              <div class="mb-3">
                <textarea class="form-control" id="newNote" [(ngModel)]="newNoteText" name="newNote" rows="3" required
                  placeholder="Enter your note here..."></textarea>
              </div>
              <button type="button" class="btn btn-primary btn-sm" (click)="addNote()"
                [disabled]="!newNoteText || !newNoteText.trim()">
                <i class="fas fa-plus me-2"></i>Add Note
              </button>
            </form>
          </div>

          <hr class="my-4">

          <!-- Notes Trail -->
          <div class="notes-trail">
            <h6 class="mb-3">Notes History</h6>

            <!-- Demo Note 1 -->
            <div class="note-item">
              <div class="note-header">
                <div class="note-author">
                  <i class="fas fa-user-circle me-2"></i>
                  <strong>Manish</strong>
                </div>
                <div class="note-timestamp">
                  <i class="fas fa-clock me-1"></i>
                  <small class="text-muted">2 hours ago</small>
                </div>
              </div>
              <div class="note-content">
                Updated pricing strategy based on market analysis. Reduced rates by 10% for weekdays.
              </div>
              <div class="note-footer">
                <button class="btn btn-sm btn-link text-danger p-0" (click)="deleteNote('note1')">
                  <i class="fas fa-trash me-1"></i>Delete
                </button>
              </div>
            </div>

            <!-- Demo Note 2 -->
            <div class="note-item">
              <div class="note-header">
                <div class="note-author">
                  <i class="fas fa-user-circle me-2"></i>
                  <strong>Ishan</strong>
                </div>
                <div class="note-timestamp">
                  <i class="fas fa-clock me-1"></i>
                  <small class="text-muted">1 day ago</small>
                </div>
              </div>
              <div class="note-content">
                Guest reported minor maintenance issue with AC. Scheduled technician visit for tomorrow.
              </div>
              <div class="note-footer">
                <button class="btn btn-sm btn-link text-danger p-0" (click)="deleteNote('note2')">
                  <i class="fas fa-trash me-1"></i>Delete
                </button>
              </div>
            </div>

            <!-- Demo Note 3 -->
            <div class="note-item">
              <div class="note-header">
                <div class="note-author">
                  <i class="fas fa-user-circle me-2"></i>
                  <strong>Manish</strong>
                </div>
                <div class="note-timestamp">
                  <i class="fas fa-clock me-1"></i>
                  <small class="text-muted">3 days ago</small>
                </div>
              </div>
              <div class="note-content">
                Property photos updated with new furniture. Listing performance expected to improve.
              </div>
              <div class="note-footer">
                <button class="btn btn-sm btn-link text-danger p-0" (click)="deleteNote('note3')">
                  <i class="fas fa-trash me-1"></i>Delete
                </button>
              </div>
            </div>

            <!-- Empty State -->
            <div class="text-center py-4 text-muted" *ngIf="false">
              <i class="fas fa-sticky-note fa-2x mb-2"></i>
              <p>No notes yet. Add your first note above.</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeNotesModal()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Backdrop for Notes -->
  <div class="modal-backdrop fade" [class.show]="showNotesModal" *ngIf="showNotesModal" (click)="closeNotesModal()">
  </div>
</div>