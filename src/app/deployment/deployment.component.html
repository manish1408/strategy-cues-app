<div class="revenue-dashboard">


  <div class="deployment-cues-container">
    <div class="row">
      <div class="col-4">
        <button class="btn btn-primary btn-lg float-end" style="margin-top: 30%;" 
                (click)="previousCue()" 
                [disabled]="isPreviousDisabled()">
          <i class="fas fa-chevron-left"></i>
        </button>
      </div>
      <div class="col-4">
        <div class="cue-card" *ngIf="getCurrentDeploymentCue(); let deploymentCue">
          <div class="cue-card-header">
            <div class="cue-card-title">
              <h6>{{ deploymentCue.deploymentCueName }}</h6>
              <!-- <span class="badge" [ngClass]="getStatusBadgeClass(deploymentCue.status)">{{ deploymentCue.status | titlecase }}</span> -->
            <span class="badge bg-secondary">Critical</span>
            </div>
            <div class="cue-card-actions">
              <button class="btn btn-sm btn-outline-primary me-1" (click)="openCueFormModal(null)" title="Add">
                <i class="fas fa-plus"></i>
              </button>
              <button class="btn btn-sm btn-outline-primary me-1" (click)="openCueFormModal(deploymentCue.id)"
                title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" (click)="deleteCue(deploymentCue.id)" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="cue-card-body">
            <div class="cue-conditions">
              <div class="condition-row">
                <strong>Days left:</strong> 45-28
              </div>
              <div class="condition-row">
                <strong>Base occupancy:</strong> 20%
              </div>
            </div>
            <div class="pickup-case">
              <div class="row">
                <div class="col-8">
                  <strong>Pickup Case 1:</strong> 0
                  <div class="action-badge">Reduce the month by 15%</div>
                </div>
                <div class="col-4">
                  <button class="btn btn-sm btn-primary float-end" title="Add Note">Add</button>
                </div>
              </div>
            </div>
           
            <div class="pickup-case">
              <div class="row">
                <div class="col-8">
                  <strong>Pickup Case 2:</strong> 0
                  <div class="action-badge">Reduce the month by 15%</div>
                </div>
                <div class="col-4">
                  <button class="btn btn-sm btn-primary float-end" title="Add Note">Add</button>
                </div>
              </div>
            </div>

            <div class="pickup-case">
              <div class="row">
                <div class="col-8">
                  <strong>Pickup Case 3:</strong> 0
                  <div class="action-badge">Reduce the month by 15%</div>
                </div>
                <div class="col-4">
                  <button class="btn btn-sm btn-primary float-end" title="Add Note">Add</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-4">
        <button class="btn btn-primary btn-lg" style="margin-top: 30%;" 
                (click)="nextCue()" 
                [disabled]="isNextDisabled()">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>



    <div *ngIf="loading" class="text-center py-3">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">Loading ...</span>
      </div>
    </div>
    <div class="table-container mt-4">
      <div *ngIf="!loading && getDeploymentCuesProperties() && getDeploymentCuesProperties().length > 0">
        <table>
          <thead>
            <tr>
              <th>Listing Name</th>
              <th>Deployment Cue</th>
              <th>Pick Up Case</th>
              <th>Assigned To</th>
              <th>Status</th>
              <th>Notes</th>
              <th>Occupancy This Month</th>
              <th>Occupancy Next Month</th>
              <th>Average Daily Rate</th>
              <th>Revenue Per Available Room</th>
              <th>Market Penetration Index</th>
              <th>STLY <br />Var Occ</th>
              <th>STLY Var <br /> RevPAR</th>
              <th>Min Rate <br /> Threshold</th>
              <th>Pick up Occ</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let property of getDeploymentCuesProperties()">
              <td class="property-cell">
                <div class="property-info">
                  <div class="property-details">
                    <h4 [title]="property.Listing_Name" [attr.aria-label]="property.Listing_Name">{{
                      property.Listing_Name
                      }}</h4>

                  </div>
                </div>
              </td>
              <td class="deployment-cues-cell">
                <!-- Real Deployment Cues Data -->
                <div class="cues-container">
                  <div class="cue-item" *ngFor="let deploymentCue of getDeploymentCuesForProperty(property)">
                    <div class="cue-name">{{ deploymentCue.deploymentCueName }}</div>
                  </div>
                </div>
              </td>
              <td class="pickup-case-cell">
                <div class="pickup-case-container">
                  <div class="pickup-case-item">
                    <div class="pickup-case-name">Pick Up Case 2</div>
                  </div>
                </div>
              </td>
              <td class="assigned-to-cell">
                <select class="form-select form-select-sm" 
                        [value]="getCurrentAssignee(property)"
                        (change)="onAssigneeChange(property, $event)">
                  <option value="">Select Assignee</option>
                  <option value="Ishan">Ishan</option>
                  <option value="Manish">Manish</option>
                  <option value="Saket">Saket</option>
                </select>
              </td>
              <td class="status-cell">
                <select class="form-select form-select-sm status-dropdown"
                        [value]="getCurrentStatus(property)"
                        (change)="onStatusChange(property, $event)">
                  <option value="">Select Status</option>
                  <option value="pending">Pending</option>
                  <option value="completed">Completed</option>
                  <option value="failed">Failed</option>
                </select>
              </td>
              <td class="notes-cell">
                <div class="notes-container">
                  <button class="btn btn-sm btn-outline-secondary" (click)="openNotesModal(property._id)">
                    <i class="fas fa-sticky-note me-1"></i>
                    <span class="notes-count">{{ getNotesCountForProperty(property) }} Notes</span>
                  </button>
                </div>
              </td>
              <td>
                <span class="badge badge-light-gray me-1">
                  {{ safeParseNumber(property.Occupancy.TM) || 0 }} %
                </span>
              </td>
              <td>
                <span class="badge badge-light-gray me-1">
                  {{ safeParseNumber(property.Occupancy.NM) || 0 }} %
                </span>
              </td>
              <td>
                <div class="dual-value-cell">
                  <div class="value-pair" *ngIf="property.ADR">
                    <span class="badge badge-light-gray me-1">This Month: {{ property.ADR.TM || 'N/A'
                      }}</span>
                    <span class="badge badge-light-gray">Next Month: {{ property.ADR.NM || 'N/A'
                      }}</span>
                  </div>
                  <div class="value-pair" *ngIf="!property.ADR">
                    <span class="text-muted">N/A</span>
                  </div>
                </div>
              </td>
              <td>
                <div class="dual-value-cell">
                  <div class="value-pair" *ngIf="property.RevPAR">
                    <span class="badge badge-light-gray me-1">This Month: {{ property.RevPAR.TM || 'N/A'
                      }}</span>
                    <span class="badge badge-light-gray">Next Month: {{ property.RevPAR.NM || 'N/A'
                      }}</span>
                  </div>
                  <div class="value-pair" *ngIf="!property.RevPAR">
                    <span class="text-muted">N/A</span>
                  </div>
                </div>
              </td>
              <td>
                <div class="dual-value-cell">
                  <div class="value-pair" *ngIf="property.MPI">
                    <span class="badge badge-light-gray me-1">This Month: {{ safeParseNumber(property.MPI.TM) }}%</span>
                    <span class="badge badge-light-gray me-1">Next Month: {{ safeParseNumber(property.MPI.NM) }}%</span>
                    <span class="badge badge-light-gray me-1">LYTM: {{ safeParseNumber(property.MPI.LYTM) }}%</span>
                  </div>
                  <div class="value-pair" *ngIf="!property.MPI">
                    <span class="text-muted">N/A</span>
                  </div>
                </div>
              </td>
              <td>
                <div class="stly-var-single-cell">
                  <span class="badge" [ngClass]="getPerformanceClass(property.STLY_Var.Occ)">
                    {{ property.STLY_Var.Occ }}
                  </span>
                </div>
              </td>
              <td>
                <div class="stly-var-single-cell">
                  <span class="badge" [ngClass]="getPerformanceClass(property.STLY_Var.RevPAR)">
                    {{ property.STLY_Var.RevPAR }}
                  </span>
                </div>
              </td>
              <td>
                <div class="min-rate-threshold-cell">
                  <span class="threshold-value">{{ property.Min_Rate_Threshold || 'N/A' }}</span>
                </div>
              </td>
              <td>
                <div class="pickup-occ-cell">
                  <div class="pickup-item"
                    *ngIf="property.Pick_Up_Occ && property.Pick_Up_Occ['7_Days'] !== null && property.Pick_Up_Occ['7_Days'] !== undefined">
                    <span class="pickup-label">7D:</span>
                    <span class="pickup-value">{{ property.Pick_Up_Occ['7_Days'] }}</span>
                  </div>
                  <div class="pickup-item"
                    *ngIf="!property.Pick_Up_Occ || property.Pick_Up_Occ['7_Days'] === null || property.Pick_Up_Occ['7_Days'] === undefined">
                    <span class="pickup-label">7D:</span>
                    <span class="pickup-value na-value">N/A</span>
                  </div>
                  <div class="pickup-item"
                    *ngIf="property.Pick_Up_Occ && property.Pick_Up_Occ['14_Days'] !== null && property.Pick_Up_Occ['14_Days'] !== undefined">
                    <span class="pickup-label">14D:</span>
                    <span class="pickup-value">{{ property.Pick_Up_Occ['14_Days'] }}</span>
                  </div>
                  <div class="pickup-item"
                    *ngIf="!property.Pick_Up_Occ || property.Pick_Up_Occ['14_Days'] === null || property.Pick_Up_Occ['14_Days'] === undefined">
                    <span class="pickup-label">14D:</span>
                    <span class="pickup-value na-value">N/A</span>
                  </div>
                  <div class="pickup-item"
                    *ngIf="property.Pick_Up_Occ && property.Pick_Up_Occ['30_Days'] !== null && property.Pick_Up_Occ['30_Days'] !== undefined">
                    <span class="pickup-label">30D:</span>
                    <span class="pickup-value">{{ property.Pick_Up_Occ['30_Days'] }}</span>
                  </div>
                  <div class="pickup-item"
                    *ngIf="!property.Pick_Up_Occ || property.Pick_Up_Occ['30_Days'] === null || property.Pick_Up_Occ['30_Days'] === undefined">
                    <span class="pickup-label">30D:</span>
                    <span class="pickup-value na-value">N/A</span>
                  </div>
                </div>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary btn-sm" (click)="viewDetails(property._id)">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Empty State -->
      <div *ngIf="!loading && (!getDeploymentCuesProperties() || getDeploymentCuesProperties().length === 0)" class="text-center py-5">
        <div class="empty-state">
          <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No Properties Found</h5>
          <p class="text-muted">No properties match your current filters.</p>
        </div>
      </div>
    </div>
  </div>


  <!-- Deployment Cue Form Modal -->
  <div class="modal fade" id="cueFormModal" tabindex="-1" aria-labelledby="cueFormModalLabel" aria-hidden="true"
    [class.show]="showCueFormModal" [style.display]="showCueFormModal ? 'block' : 'none'">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" style="overflow: visible;">
        <div class="modal-header">
          <h5 class="modal-title" id="cueFormModalLabel">
            <i class="fas fa-edit me-2"></i>{{ editingCueId ? 'Edit' : 'Create' }} Deployment Cue
          </h5>
          <button type="button" class="btn-close" (click)="closeCueFormModal()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form #cueForm="ngForm">
            <div class="mb-3">
              <label for="deploymentCueName" class="form-label">Deployment Cue Name *</label>
              <input type="text" class="form-control" id="deploymentCueName" [(ngModel)]="cueFormData.deploymentCueName" name="deploymentCueName"
                required placeholder="Enter deployment cue name">
            </div>

            <div class="mb-3" style="position: relative; z-index: 9999;">
              <label for="cueProperties" class="form-label">Property *</label>
              <ngx-select-dropdown [config]="propertyDropdownConfig" [options]="propertyOptions"
                [(ngModel)]="cueFormData.properties" name="cueProperties" [multiple]="false"
                (change)="onPropertySelectionChange()" style="position: relative; z-index: 9999;">
              </ngx-select-dropdown>
              <small class="text-muted">Search and select a property</small>
            </div>

            <!-- Additional fields only for edit mode -->
            <div *ngIf="editingCueId">
              <div class="mb-3">
                <label for="assignedTo" class="form-label">Assigned To</label>
                <select class="form-select" id="assignedTo" [(ngModel)]="cueFormData.assignedTo" name="assignedTo">
                  <option value="">Select Assignee</option>
                  <option value="Ishan">Ishan</option>
                  <option value="Manish">Manish</option>
                  <option value="Saket">Saket</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="cueStatus" class="form-label">Status *</label>
                <select class="form-select" id="cueStatus" [(ngModel)]="cueFormData.status" name="cueStatus" required>
                  <option value="">Select Status</option>
                  <option value="pending">Pending</option>
                  <option value="completed">Completed</option>
                  <option value="failed">Failed</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="notes" class="form-label">Notes</label>
                <textarea class="form-control" id="notes" [(ngModel)]="cueFormData.notes"
                  name="notes" rows="3" placeholder="Add any notes for this deployment cue"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeCueFormModal()" [disabled]="cueFormLoading">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="saveCue()" [disabled]="!cueForm.form.valid || cueFormLoading">
            <div *ngIf="cueFormLoading" class="spinner-border spinner-border-sm me-2" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <i *ngIf="!cueFormLoading" class="fas fa-save me-2"></i>
            {{ editingCueId ? 'Update' : 'Create' }} Cue
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Backdrop for Cue Form -->
  <div class="modal-backdrop fade" [class.show]="showCueFormModal" *ngIf="showCueFormModal"
    (click)="closeCueFormModal()"></div>

  <!-- Notes Modal -->
  <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true"
    [class.show]="showNotesModal" [style.display]="showNotesModal ? 'block' : 'none'">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="notesModalLabel">
            <i class="fas fa-sticky-note me-2"></i>Notes
          </h5>
          <button type="button" class="btn-close" (click)="closeNotesModal()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Add New Note Section -->
          <div class="add-note-section">
            <h6 class="mb-3">Add New Note</h6>
            <form #noteForm="ngForm">
              <div class="mb-3">
                <textarea class="form-control" id="newNote" [(ngModel)]="newNoteText" name="newNote" rows="3" required
                  placeholder="Enter your note here..."></textarea>
              </div>
              <button type="button" class="btn btn-primary btn-sm" (click)="addNote()"
                [disabled]="!newNoteText || !newNoteText.trim()">
                <i class="fas fa-plus me-2"></i>Add Note
              </button>
            </form>
          </div>

          <hr class="my-4">

          <!-- Notes Trail -->
          <div class="notes-trail">
            <h6 class="mb-3">Notes History</h6>

            <!-- Demo Note 1 -->
            <div class="note-item">
              <div class="note-header">
                <div class="note-author">
                  <i class="fas fa-user-circle me-2"></i>
                  <strong>Manish</strong>
                </div>
                <div class="note-timestamp">
                  <i class="fas fa-clock me-1"></i>
                  <small class="text-muted">2 hours ago</small>
                </div>
              </div>
              <div class="note-content">
                Updated pricing strategy based on market analysis. Reduced rates by 10% for weekdays.
              </div>
              <div class="note-footer">
                <button class="btn btn-sm btn-link text-danger p-0" (click)="deleteNote('note1')">
                  <i class="fas fa-trash me-1"></i>Delete
                </button>
              </div>
            </div>

            <!-- Demo Note 2 -->
            <div class="note-item">
              <div class="note-header">
                <div class="note-author">
                  <i class="fas fa-user-circle me-2"></i>
                  <strong>Ishan</strong>
                </div>
                <div class="note-timestamp">
                  <i class="fas fa-clock me-1"></i>
                  <small class="text-muted">1 day ago</small>
                </div>
              </div>
              <div class="note-content">
                Guest reported minor maintenance issue with AC. Scheduled technician visit for tomorrow.
              </div>
              <div class="note-footer">
                <button class="btn btn-sm btn-link text-danger p-0" (click)="deleteNote('note2')">
                  <i class="fas fa-trash me-1"></i>Delete
                </button>
              </div>
            </div>

            <!-- Demo Note 3 -->
            <div class="note-item">
              <div class="note-header">
                <div class="note-author">
                  <i class="fas fa-user-circle me-2"></i>
                  <strong>Manish</strong>
                </div>
                <div class="note-timestamp">
                  <i class="fas fa-clock me-1"></i>
                  <small class="text-muted">3 days ago</small>
                </div>
              </div>
              <div class="note-content">
                Property photos updated with new furniture. Listing performance expected to improve.
              </div>
              <div class="note-footer">
                <button class="btn btn-sm btn-link text-danger p-0" (click)="deleteNote('note3')">
                  <i class="fas fa-trash me-1"></i>Delete
                </button>
              </div>
            </div>

            <!-- Empty State -->
            <div class="text-center py-4 text-muted" *ngIf="false">
              <i class="fas fa-sticky-note fa-2x mb-2"></i>
              <p>No notes yet. Add your first note above.</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeNotesModal()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Backdrop for Notes -->
  <div class="modal-backdrop fade" [class.show]="showNotesModal" *ngIf="showNotesModal" (click)="closeNotesModal()">
  </div>
</div>